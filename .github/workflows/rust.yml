name: CI

on:
  push:
    branches: ["dev", "dev_ci"]
  pull_request:
    branches: ["dev", "dev_ci"]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Prepare vintage_mc_redis
        run: docker run  -d    -v /home/runner/work/breeze:/data1/resource/breeze  --net="host"  --name breeze_github_ci ficohu/breeze:githubci003
      - uses: actions/checkout@v3
      - name: Build
        run: cargo build --verbose
      - name: Create Socks
        run: |
          mkdir -p /home/runner/work/breeze/logs
          mkdir -p /home/runner/work/breeze/snapshot
          mkdir -p /home/runner/work/breeze/socks
          touch /home/runner/work/breeze/socks/config+cloud+redis+testbreeze+redismeshtest@redis:56810@rs
      - name: Run
        run: cargo run --features enable-log -- --discovery vintage://10.182.27.228:8080 --snapshot /home/runner/work/breeze/snapshot --service-path /home/runner/work/breeze/socks --log-dir /home/runner/work/breeze/logs --metrics-url logtailer.monitor.weibo.com:8333 --upgrade --port 9984 --metrics-probe 10.10.10.10:53 --log-level info
      - name: Run tests
        run: cargo test --verbose
